= Configuring Location Profiles

== 1. Introduction

You have now configured everything required to perform a local snapshot of a Kubernetes application using Kasten - _but snapshots are not backup!_ In order to restore in the event the local cluster or primary storage is compromised, a copy of that data should be exported to another location.

The configuration of these backup targets are called *_Location Profiles_*.
Kasten https://docs.kasten.io/latest/usage/configuration.html[supports several options], including:

* AWS S3
* Azure Blob
* Google Cloud Storage
* S3-Compatible
* NFS
* Veeam Backup & Recovery

Kasten supports the creation of immutable backups to ensure that, as a last line of defense against ransomware, backup data cannot be manipulated or deleted by any user.
These backups are supported on the following platforms:

* AWS S3
* S3-Compatible with Object Lock support (ex.
Ceph, MinIO, Wasabi, etc.)
* Azure Blob
* Google Cloud Storage

'''

_In this exercise, you will configure an immutable bucket using the on-cluster Ceph Object Gateway deployment and add the bucket as a Location Profile in Kasten._

====
[CAUTION]

In a real world environment you should never back up data to the same infrastructure you are intending to protect - using on-cluster storage as a backup target is performed in the lab solely to simplify lab staging and instructions.
====

== 2. Configuring an Object Bucket Claim to Store Backups

====
[CAUTION]

Kasten supports immutable object storage and it is recommended to protect backups against accidental deletion or ransomware attack. For this lab, we won't configure immutability as it requires elevated permissions.
====

. Open an OpenShift command line terminal
+
image::module-02-location-profile/002.png[]
+
====
[NOTE]

If this is the first time you are opening a terminal you may need to *Create a Project* first to run your terminal pod in. In that case make sure you use `terminal-{user}` as your project name to ensure that it is unique to you.
====

. Run the following command to retrieve the Access Key for the Multicloud Object Gateway:
+
[source,bash]
----
oc get secret -n backuptarget kastenbackups -ojsonpath='{.data.AWS_ACCESS_KEY_ID}' | base64 --decode && echo
----
+
Copy the Access Key to a text editor as it will be needed again shortly

. Run the following command to retrieve the Secret Key for the Multicloud Object Gateway:
+
[source,bash]
----
oc get secret -n backuptarget-{user} kastenbackups -ojsonpath='{.data.AWS_SECRET_ACCESS_KEY}' | base64 --decode && echo
----
+
Copy the Secret Key to a text editor as it will be needed again shortly

. Run the following command to retrieve the S3 endpoint address
+
[source,bash]
----
oc get route s3 -n openshift-storage -ojson | jq -r '.spec.host'
----
+
Copy the Endpoint Address to a text editor as it will be needed again shortly

== 3. Creating an S3-Compatible Location Profile

. In the *_Kasten Dashboard_*, select *_Profiles → Location_* from the sidebar and click *_+ Add New_*.
+
image::module-02-location-profile/01.png[]

. Fill out the following fields and click *_Next_*:
+
|===
|  |

| *_Location Profile Name_*
| `kastenbackups-{user}`

| *_Storage Provider_*
| S3 Compatible
|===
+
image::module-02-location-profile/02.png[]

. Fill out the following fields *_but DO NOT click Next yet!_*:
+
|===
|  |

| *_S3 Access Key_*
| Paste `ACCESS KEY` value

| *_S3 Secret_*
| Paste `SECRET KEY` value

| *_Endpoint_*
| Paste `ENDPOINT` value

| *_Region_*
| `us-east-1`

| *_Bucket_*
| `kasten`
|===
+
image::module-02-location-profile/02b.png[]

. Click *_Next → Save Profile_*.
+
You should expect your `ceph-rgw-immutable` Location Profile to appear with a *_Success_* status.
+
image::module-02-location-profile/05.png[]
+
Now you're ready to start protecting apps!

. Click the *_..._* menu and select *_View YAML_* to view the manifest generated by creating a Location Profile through the Dashboard.
+
image::module-02-location-profile/06.png[]
+
As you can see from this example, Kasten Location Profiles can be created declaratively as a `profile.config.kio.kasten.io` object referencing a Secret to store access and secret keys.
This Kubernetes-native implementation makes it simple to configure backup targets using a GitOps approach.
+
====
[NOTE]

See https://docs.kasten.io/latest/api/profiles.html[docs.kasten.io] for complete documentation on defining Profile API objects.
====

. Click *_Cancel_* or the *_X_* in the upper-right to close the YAML window.
